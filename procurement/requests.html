<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Requests · Central Kitchen Procurement</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    /* ── Compact list ── */
    .req-list { display: flex; flex-direction: column; gap: 6px; }

    .req-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(180deg, var(--card), #fffbf9);
      border: 1px solid var(--border);
      border-left: 4px solid var(--steel);
      border-radius: 10px;
      padding: 10px 14px;
      box-shadow: 0 2px 6px var(--shadow);
      transition: box-shadow 0.15s;
    }
    .req-row:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.09); }
    .req-row.done  { border-left-color: var(--success); opacity: 0.7; }

    /* Done tickbox */
    .done-wrap { flex-shrink: 0; display: flex; align-items: center; }
    .done-cb {
      width: 20px; height: 20px;
      accent-color: var(--success);
      cursor: pointer;
    }

    /* Thumbnail */
    .req-thumb {
      width: 40px; height: 40px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--border);
      flex-shrink: 0;
      cursor: pointer;
    }

    /* Main text block */
    .req-body { flex: 1; min-width: 0; }
    .req-name {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-decoration: none;
      display: block;
    }
    .req-name:hover { color: var(--accent); text-decoration: underline; }
    .req-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 3px;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .req-meta span { white-space: nowrap; }
    .req-comment {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 480px;
    }

    /* Done date stamp */
    .done-date {
      display: inline-block;
      margin-top: 4px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--success);
      background: rgba(39,174,96,0.10);
      border: 1px solid rgba(39,174,96,0.25);
      border-radius: 20px;
      padding: 2px 10px;
    }

    /* Right side */
    .req-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .req-date  { font-size: 0.72rem; color: var(--muted); white-space: nowrap; }

    .del-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1rem;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 6px;
      box-shadow: none;
      transition: color 0.15s, background 0.15s;
    }
    .del-btn:hover { color: var(--accent); background: rgba(192,57,43,0.08); transform: none; box-shadow: none; }

    /* Stats compact */
    .stats-bar .stat-box .num { font-size: 1.4rem; }

    /* Filters compact */
    .filters { padding: 10px 16px; }
    .filters input, .filters select { font-size: 0.82rem; padding: 6px 10px; }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <a href="/" style="line-height:0;flex-shrink:0;"><img class="site-logo" src="assets/logo.png" alt="Chilli API" style="cursor:pointer;"/></a>
    <div class="header-text">
      <h1>All Procurement Requests</h1>
      <p>所有采购申请 · Central Kitchen</p>
    </div>
  </div>
  <nav class="nav-links">
    <a href="/">🏠 Home</a>
    <a href="/request" class="accent">+ New Request</a>
  </nav>
</header>

<main>
  <!-- Stats -->
  <div class="card" style="margin-bottom:14px;">
    <h2>📊 Overview</h2>
    <div class="stats-bar" id="statsBar">
      <div class="stat-box"><div class="num" id="statTotal">—</div><div class="lbl">Total</div></div>
      <div class="stat-box"><div class="num" id="statPending">—</div><div class="lbl">Pending</div></div>
      <div class="stat-box"><div class="num" id="statDone">—</div><div class="lbl">Done</div></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <input type="text" id="searchInput" placeholder="🔍 Search item / requestor..."/>
    <select id="filterStatus">
      <option value="">All</option>
      <option value="Pending">Pending</option>
      <option value="Done">Done</option>
    </select>
    <button class="btn btn-outline btn-sm" onclick="loadRequests()">🔄 Refresh</button>
  </div>

  <div class="req-list" id="requestsList">
    <p style="color:var(--muted);text-align:center;padding:40px;">Loading…</p>
  </div>
</main>

<!-- Image modal -->
<div class="modal-overlay" id="imgModal" onclick="this.classList.remove('open')">
  <img id="modalImg" src="" alt=""/>
</div>

<script>
  let allRequests = [];

  async function loadRequests() {
    const qs = [];
    const search = document.getElementById('searchInput').value.trim();
    const status = document.getElementById('filterStatus').value;
    if (search) qs.push(`search=${encodeURIComponent(search)}`);
    if (status) qs.push(`status=${encodeURIComponent(status)}`);

    try {
      const data = await fetch(`/api/requests${qs.length ? '?' + qs.join('&') : ''}`).then(r => r.json());
      allRequests = data;
      renderRequests(data);
      updateStats(data);
    } catch (err) {
      document.getElementById('requestsList').innerHTML = `<p style="color:red">Failed to load: ${err.message}</p>`;
    }
  }

  function updateStats(data) {
    // fetch all for accurate totals regardless of filter
    fetch('/api/requests').then(r => r.json()).then(all => {
      document.getElementById('statTotal').textContent   = all.length;
      document.getElementById('statPending').textContent = all.filter(r => r.status === 'Pending').length;
      document.getElementById('statDone').textContent    = all.filter(r => r.status === 'Done').length;
    }).catch(() => {});
  }

  function renderRequests(requests) {
    const container = document.getElementById('requestsList');
    if (!requests.length) {
      container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:30px;">No requests found.</p>';
      return;
    }

    container.innerHTML = requests.map(r => {
      const done  = r.status === 'Done';
      const thumb = r.imagePath
        ? `<img class="req-thumb" src="${r.imagePath}" alt="" onclick="openModal('${r.imagePath}')" title="Click to enlarge"/>`
        : '';

      const meta = [
        r.requestorName ? `👤 ${escHtml(r.requestorName)}` : '',
        r.department    ? `🏢 ${escHtml(r.department)}` : '',
        r.quantity      ? `Qty: ${escHtml(r.quantity)}` : '',
      ].filter(Boolean).join(' · ');

      const submittedDate = new Date(r.createdAt).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
      const completedDate = r.completedAt
        ? new Date(r.completedAt).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' })
        : null;
      const doneDateHtml = done && completedDate
        ? `<div><span class="done-date">✅ Done: ${completedDate}</span></div>`
        : '';

      return `
        <div class="req-row${done ? ' done' : ''}" id="card-${r._id}">
          <div class="done-wrap">
            <input class="done-cb" type="checkbox" ${done ? 'checked' : ''}
              onchange="toggleDone('${r._id}', this.checked)" title="${done ? 'Mark Pending' : 'Mark Done'}"/>
          </div>
          ${thumb}
          <div class="req-body">
            <a class="req-name" href="/request/${r._id}">${escHtml(r.itemNameEn)}</a>
            <div class="req-meta"><span>${meta}</span></div>
            ${r.comments ? `<div class="req-comment">💬 ${escHtml(r.comments)}</div>` : ''}
            <div id="done-date-${r._id}">${doneDateHtml}</div>
          </div>
          <div class="req-right">
            <span class="req-date">${submittedDate}</span>
            <span class="badge ${done ? 'badge-received' : 'badge-pending'}" id="badge-${r._id}">${done ? 'Done' : 'Pending'}</span>
            <button class="del-btn" onclick="deleteRequest('${r._id}')" title="Delete">🗑</button>
          </div>
        </div>
      `;
    }).join('');
  }

  async function toggleDone(id, checked) {
    const status = checked ? 'Done' : 'Pending';
    try {
      const updated = await fetch(`/api/requests/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      }).then(r => r.json());
      const card     = document.getElementById(`card-${id}`);
      const badge    = document.getElementById(`badge-${id}`);
      const dateWrap = document.getElementById(`done-date-${id}`);
      if (card)  { card.className  = `req-row${checked ? ' done' : ''}`; }
      if (badge) { badge.className = `badge ${checked ? 'badge-received' : 'badge-pending'}`; badge.textContent = status; }
      if (dateWrap) {
        if (checked && updated.completedAt) {
          const d = new Date(updated.completedAt).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
          dateWrap.innerHTML = `<div><span class="done-date">✅ Done: ${d}</span></div>`;
        } else {
          dateWrap.innerHTML = '';
        }
      }
      updateStats(allRequests);
    } catch (err) { alert('Update failed: ' + err.message); }
  }

  async function deleteRequest(id) {
    if (!confirm('Delete this request?\n确定删除此申请？')) return;
    try {
      await fetch(`/api/requests/${id}`, { method: 'DELETE' });
      document.getElementById(`card-${id}`)?.remove();
      updateStats(allRequests);
    } catch (err) { alert('Delete failed: ' + err.message); }
  }

  function openModal(src) {
    document.getElementById('modalImg').src = src;
    document.getElementById('imgModal').classList.add('open');
  }

  function escHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  let searchTimer;
  document.getElementById('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(loadRequests, 350);
  });
  document.getElementById('filterStatus').addEventListener('change', loadRequests);

  loadRequests();
</script>
</body>
</html>
