<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request Detail ¬∑ Central Kitchen Procurement</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
    }
    @media (max-width: 600px) { .detail-grid { grid-template-columns: 1fr; } }

    .detail-field { display: flex; flex-direction: column; gap: 3px; }
    .detail-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .detail-value {
      font-size: 0.92rem;
      color: var(--ink);
      font-weight: 500;
    }
    .detail-value.large {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .detail-value.zh {
      font-size: 1rem;
      color: var(--muted);
      font-weight: 400;
    }
    .detail-value.empty { color: var(--muted); font-style: italic; font-weight: 400; }

    /* Image */
    .req-image {
      width: 100%;
      max-height: 320px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f8f4f2;
      cursor: pointer;
    }

    /* Status selector */
    .status-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .status-select {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 0.88rem;
      background: var(--card);
      color: var(--ink);
      cursor: pointer;
    }
    .save-status-btn {
      padding: 6px 16px;
      font-size: 0.82rem;
    }

    /* Checklist */
    .checklist-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 20px;
    }
    @media (max-width: 480px) { .checklist-grid { grid-template-columns: 1fr; } }

    .check-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--ink);
      cursor: pointer;
    }
    .check-item input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: var(--success);
      cursor: pointer;
      flex-shrink: 0;
    }

    /* Notes */
    .notes-area {
      width: 100%;
      min-height: 80px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-family: inherit;
      font-size: 0.88rem;
      color: var(--ink);
      background: var(--card);
      resize: vertical;
      box-sizing: border-box;
    }

    /* Priority / Category badges */
    .badge-high   { background: #c0392b22; color: #c0392b; }
    .badge-urgent { background: #e74c3c33; color: #c0392b; font-weight: 700; }
    .badge-medium { background: #e6700022; color: #d35400; }
    .badge-low    { background: #2ecc7122; color: #27ae60; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: zoom-out;
    }
    .modal-overlay.open { display: flex; }
    .modal-overlay img {
      max-width: 92vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      text-decoration: none;
      margin-bottom: 12px;
      transition: color 0.15s;
    }
    .back-link:hover { color: var(--accent); }

    .save-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
    .save-msg { font-size: 0.8rem; color: var(--success); opacity: 0; transition: opacity 0.3s; }
    .save-msg.show { opacity: 1; }

    #errorMsg { color: var(--accent); text-align: center; padding: 40px; }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <img class="site-logo" src="assets/logo.png" onerror="this.style.display='none'" alt=""/>
    <div class="header-text">
      <h1 id="pageTitle">Request Detail</h1>
      <p>Central Kitchen Procurement ¬∑ ÈááË¥≠Áî≥ËØ∑ËØ¶ÊÉÖ</p>
    </div>
  </div>
  <nav class="nav-links">
    <a href="/">üè† Home</a>
    <a href="/requests">üìã All Requests</a>
    <a href="/request" class="accent">+ New Request</a>
  </nav>
</header>

<main>
  <a class="back-link" href="/requests">‚Üê Back to All Requests</a>

  <div id="errorMsg" style="display:none;">Request not found.</div>

  <!-- Item Info -->
  <div class="card" id="cardItem" style="display:none;">
    <h2>üì¶ Item Details</h2>
    <div style="margin-bottom:16px;">
      <div class="detail-value large" id="dItemEn">‚Äî</div>
      <div class="detail-value zh"    id="dItemZh"></div>
    </div>
    <div class="detail-grid">
      <div class="detail-field">
        <span class="detail-label">Category</span>
        <span class="detail-value" id="dCategory">‚Äî</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Quantity</span>
        <span class="detail-value" id="dQuantity">‚Äî</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Estimated Price</span>
        <span class="detail-value" id="dPrice">‚Äî</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Supplier</span>
        <span class="detail-value" id="dSupplier">‚Äî</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Priority</span>
        <span class="detail-value" id="dPriority">‚Äî</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Date Needed</span>
        <span class="detail-value" id="dDateNeeded">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- Image -->
  <div class="card" id="cardImage" style="display:none;">
    <h2>üñº Photo</h2>
    <img class="req-image" id="dImage" src="" alt="Item photo"
         onclick="openModal(this.src)" title="Click to enlarge"/>
  </div>

  <!-- Requestor -->
  <div class="card" id="cardRequestor" style="display:none;">
    <h2>üë§ Requestor</h2>
    <div class="detail-grid">
      <div class="detail-field">
        <span class="detail-label">Name</span>
        <span class="detail-value" id="dName">‚Äî</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Department</span>
        <span class="detail-value" id="dDepartment">‚Äî</span>
      </div>
    </div>
    <div class="detail-field" style="margin-top:12px;" id="commentBlock">
      <span class="detail-label">Comments</span>
      <span class="detail-value" id="dComments">‚Äî</span>
    </div>
    <div style="display:flex; gap:20px; margin-top:14px; font-size:0.75rem; color:var(--muted);">
      <span>Submitted: <strong id="dCreated">‚Äî</strong></span>
      <span>Updated: <strong id="dUpdated">‚Äî</strong></span>
    </div>
  </div>

  <!-- Status & Purchaser Tools -->
  <div class="card" id="cardStatus" style="display:none;">
    <h2>‚öôÔ∏è Purchaser Actions</h2>

    <div class="detail-field" style="margin-bottom:16px;">
      <span class="detail-label">Status</span>
      <div class="status-row">
        <select class="status-select" id="statusSelect">
          <option value="Pending">Pending</option>
          <option value="Done">Done</option>
          <option value="Approved">Approved</option>
          <option value="Ordered">Ordered</option>
          <option value="Received">Received</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <button class="btn btn-sm save-status-btn" onclick="saveStatus()">Save Status</button>
        <span class="save-msg" id="statusMsg">‚úì Saved</span>
      </div>
    </div>

    <div class="detail-field" style="margin-bottom:16px;">
      <span class="detail-label" style="margin-bottom:8px;">Checklist</span>
      <div class="checklist-grid" id="checklistGrid">
        <label class="check-item"><input type="checkbox" id="ck_quoteObtained"/>     Quote Obtained</label>
        <label class="check-item"><input type="checkbox" id="ck_managerApproved"/>   Manager Approved</label>
        <label class="check-item"><input type="checkbox" id="ck_orderPlaced"/>       Order Placed</label>
        <label class="check-item"><input type="checkbox" id="ck_paymentProcessed"/>  Payment Processed</label>
        <label class="check-item"><input type="checkbox" id="ck_itemReceived"/>      Item Received</label>
        <label class="check-item"><input type="checkbox" id="ck_invoiceFiled"/>      Invoice Filed</label>
      </div>
    </div>

    <div class="detail-field">
      <span class="detail-label" style="margin-bottom:6px;">Purchaser Notes</span>
      <textarea class="notes-area" id="purchaserNotes" placeholder="Internal notes‚Ä¶"></textarea>
    </div>

    <div class="save-row">
      <button class="btn btn-sm" onclick="saveChecklist()">üíæ Save Checklist & Notes</button>
      <span class="save-msg" id="checklistMsg">‚úì Saved</span>
    </div>
  </div>
</main>

<!-- Image modal -->
<div class="modal-overlay" id="imgModal" onclick="this.classList.remove('open')">
  <img id="modalImg" src="" alt=""/>
</div>

<script>
  const id = location.pathname.split('/').pop();

  async function loadRequest() {
    try {
      const r = await fetch(`/api/requests/${id}`).then(res => {
        if (!res.ok) throw new Error('Not found');
        return res.json();
      });

      // Page title
      document.title = `${r.itemNameEn} ¬∑ Procurement`;
      document.getElementById('pageTitle').textContent = r.itemNameEn;

      // Item details
      document.getElementById('dItemEn').textContent = r.itemNameEn;
      if (r.itemNameZh) document.getElementById('dItemZh').textContent = r.itemNameZh;
      document.getElementById('dCategory').textContent  = r.category  || '‚Äî';
      document.getElementById('dQuantity').textContent  = r.quantity
        ? r.quantity + (r.unit ? ' ' + r.unit : '')
        : '‚Äî';
      document.getElementById('dPrice').textContent     = r.estimatedPrice || empty();
      document.getElementById('dSupplier').textContent  = r.supplier  || empty();
      document.getElementById('dDateNeeded').textContent= r.dateNeeded || empty();

      // Priority badge
      const pEl = document.getElementById('dPriority');
      if (r.priority) {
        pEl.innerHTML = `<span class="badge badge-${r.priority.toLowerCase()}">${r.priority}</span>`;
      } else { pEl.textContent = '‚Äî'; }

      // Image
      if (r.imagePath) {
        document.getElementById('dImage').src = r.imagePath;
        document.getElementById('cardImage').style.display = '';
      }

      // Requestor
      document.getElementById('dName').textContent       = r.requestorName || '‚Äî';
      document.getElementById('dDepartment').textContent = r.department     || empty();
      document.getElementById('dComments').textContent   = r.comments       || empty();
      document.getElementById('dCreated').textContent    = fmt(r.createdAt);
      document.getElementById('dUpdated').textContent    = fmt(r.updatedAt);

      // Status
      document.getElementById('statusSelect').value = r.status || 'Pending';

      // Checklist
      const ck = r.checklist || {};
      ['quoteObtained','managerApproved','orderPlaced','paymentProcessed','itemReceived','invoiceFiled']
        .forEach(key => {
          const el = document.getElementById(`ck_${key}`);
          if (el) el.checked = !!ck[key];
        });

      // Purchaser notes
      document.getElementById('purchaserNotes').value = r.purchaserNotes || '';

      // Show cards
      ['cardItem','cardRequestor','cardStatus'].forEach(id =>
        document.getElementById(id).style.display = ''
      );

    } catch (err) {
      document.getElementById('errorMsg').style.display = '';
      document.getElementById('errorMsg').textContent = 'Failed to load request: ' + err.message;
    }
  }

  async function saveStatus() {
    const status = document.getElementById('statusSelect').value;
    try {
      await fetch(`/api/requests/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      flash('statusMsg');
    } catch (err) { alert('Save failed: ' + err.message); }
  }

  async function saveChecklist() {
    const checklist = {};
    ['quoteObtained','managerApproved','orderPlaced','paymentProcessed','itemReceived','invoiceFiled']
      .forEach(key => {
        const el = document.getElementById(`ck_${key}`);
        if (el) checklist[key] = el.checked;
      });
    const purchaserNotes = document.getElementById('purchaserNotes').value;
    try {
      await fetch(`/api/requests/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ checklist, purchaserNotes })
      });
      flash('checklistMsg');
    } catch (err) { alert('Save failed: ' + err.message); }
  }

  function flash(msgId) {
    const el = document.getElementById(msgId);
    if (!el) return;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
  }

  function fmt(dateStr) {
    if (!dateStr) return '‚Äî';
    return new Date(dateStr).toLocaleString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function empty() {
    return '‚Äî';
  }

  function openModal(src) {
    document.getElementById('modalImg').src = src;
    document.getElementById('imgModal').classList.add('open');
  }

  loadRequest();
</script>
</body>
</html>
